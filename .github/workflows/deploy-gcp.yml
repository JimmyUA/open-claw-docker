# OpenClaw GCP Deployment Workflow
# Deploys OpenClaw to Google Cloud Platform Compute Engine
# Uses the official alpine/openclaw Docker image from Docker Hub
#
# Triggers:
# - Push to main branch
# - Manual dispatch with options
#
# Required Secrets:
# - GCP_PROJECT_ID: Your GCP project ID
# - GCP_SA_KEY: Service account JSON key (base64 encoded)
# - GCP_ZONE: Compute Engine zone (e.g., us-central1-a)
# - OPENCLAW_GATEWAY_TOKEN: Gateway security token

name: Deploy to GCP

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      openclaw_image_tag:
        description: 'OpenClaw image tag (from alpine/openclaw)'
        required: true
        default: 'latest'
        type: string

env:
  INSTANCE_NAME: openclaw-gateway
  MACHINE_TYPE: e2-medium
  DISK_SIZE: 30
  # Use official pre-built image from Docker Hub
  OPENCLAW_IMAGE: alpine/openclaw:${{ github.event.inputs.openclaw_image_tag || 'latest' }}

jobs:
  deploy:
    name: Deploy to Compute Engine
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Check if VM exists
        id: check-vm
        run: |
          if gcloud compute instances describe ${{ env.INSTANCE_NAME }} --zone=${{ secrets.GCP_ZONE }} &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create VM if not exists
        if: steps.check-vm.outputs.exists == 'false'
        run: |
          gcloud compute instances create ${{ env.INSTANCE_NAME }} \
            --zone=${{ secrets.GCP_ZONE }} \
            --machine-type=${{ env.MACHINE_TYPE }} \
            --boot-disk-size=${{ env.DISK_SIZE }}GB \
            --boot-disk-type=pd-balanced \
            --image-family=debian-12 \
            --image-project=debian-cloud \
            --tags=openclaw-gateway,http-server,https-server \
            --scopes=cloud-platform \
            --metadata=startup-script='#!/bin/bash
              apt-get update
              apt-get install -y docker.io docker-compose-v2
              systemctl enable docker
              systemctl start docker
              mkdir -p /opt/openclaw
              mkdir -p /home/openclaw/.openclaw/workspace
              chown -R 1000:1000 /home/openclaw/.openclaw
            '

      - name: Wait for VM to be ready
        run: |
          echo "Waiting for VM to be ready..."
          sleep 60

      - name: Configure Docker on VM
        run: |
          # First, ensure Docker is installed and running
          gcloud compute ssh ${{ env.INSTANCE_NAME }} --zone=${{ secrets.GCP_ZONE }} --command="
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo 'Installing Docker...'
              sudo apt-get update
              sudo apt-get install -y docker.io docker-compose-v2
              sudo systemctl enable docker
              sudo systemctl start docker
            fi
            
            # Wait for Docker to be ready
            while ! sudo docker info &> /dev/null; do
              echo 'Waiting for Docker...'
              sleep 5
            done
            echo 'Docker is ready!'
            
            # Create directories
            sudo mkdir -p /opt/openclaw/config
            sudo mkdir -p /home/openclaw/.openclaw/workspace
            sudo chown -R 1000:1000 /home/openclaw/.openclaw
          "

      - name: Deploy application
        run: |
          # Copy files to home directory first (avoid permission issues)
          gcloud compute scp docker-compose.yml ${{ env.INSTANCE_NAME }}:~/docker-compose.yml --zone=${{ secrets.GCP_ZONE }}
          gcloud compute scp config/openclaw.json ${{ env.INSTANCE_NAME }}:~/openclaw.json --zone=${{ secrets.GCP_ZONE }}
          
          # Move files to /opt/openclaw with sudo and create .env
          gcloud compute ssh ${{ env.INSTANCE_NAME }} --zone=${{ secrets.GCP_ZONE }} --command="
            sudo mkdir -p /opt/openclaw/config
            sudo mv ~/docker-compose.yml /opt/openclaw/
            sudo mv ~/openclaw.json /opt/openclaw/config/
            sudo tee /opt/openclaw/.env > /dev/null << 'EOF'
          OPENCLAW_IMAGE=${{ env.OPENCLAW_IMAGE }}
          OPENCLAW_GATEWAY_TOKEN=${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          OPENCLAW_GATEWAY_BIND=lan
          OPENCLAW_GATEWAY_PORT=18789
          OPENCLAW_CONFIG_DIR=/home/openclaw/.openclaw
          OPENCLAW_WORKSPACE_DIR=/home/openclaw/.openclaw/workspace
          GOG_KEYRING_PASSWORD=${{ secrets.GOG_KEYRING_PASSWORD }}
          XDG_CONFIG_HOME=/home/node/.openclaw
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
          EOF
          "

      - name: Pull and restart containers
        run: |
          gcloud compute ssh ${{ env.INSTANCE_NAME }} --zone=${{ secrets.GCP_ZONE }} --command="
            cd /opt/openclaw
            sudo docker compose pull
            sudo docker compose up -d openclaw-gateway
            sudo docker compose ps
          "

      - name: Health check
        run: |
          sleep 30
          gcloud compute ssh ${{ env.INSTANCE_NAME }} --zone=${{ secrets.GCP_ZONE }} --command="
            sudo docker compose -f /opt/openclaw/docker-compose.yml logs --tail=50 openclaw-gateway
          "

      - name: Deployment summary
        run: |
          EXTERNAL_IP=$(gcloud compute instances describe ${{ env.INSTANCE_NAME }} \
            --zone=${{ secrets.GCP_ZONE }} \
            --format='get(networkInterfaces[0].accessConfigs[0].natIP)')
          
          echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Instance:** ${{ env.INSTANCE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Zone:** ${{ secrets.GCP_ZONE }}" >> $GITHUB_STEP_SUMMARY
          echo "**External IP:** ${EXTERNAL_IP}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access via SSH Tunnel" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "gcloud compute ssh ${{ env.INSTANCE_NAME }} --zone=${{ secrets.GCP_ZONE }} -- -L 18789:127.0.0.1:18789" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Then open: http://127.0.0.1:18789/" >> $GITHUB_STEP_SUMMARY
